<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promise实现(基础版)</title>
</head>

<body>
  <script>
    window.onload = () => {
      class MyPromise {
        #status = 'pending'
        #result = undefined
        #asyncResolveList = []
        #asyncRejectList = []
        constructor(executor) {
          const resolve = result => {
            this.#status = 'fulfilled'
            this.#result = result
            this.#asyncResolveList.forEach(fn => fn())
          }
          const reject = result => {
            this.#status = 'rejected'
            this.#result = result
            this.#asyncRejectList.forEach(fn => fn())
          }
          try {
            executor(resolve, reject)
          } catch (error) {
            reject(error)
          }
        }
        then(resolve, reject) {
          if (this.#status === 'fulfilled' && resolve) {
            resolve(this.#result)
          }
          if (this.#status === 'rejected' && reject) {
            reject(this.#result)
          }
          if (this.#status === 'pending') {
            if (resolve) {
              this.#asyncResolveList.push(() => resolve(this.#result))
            }
            if (reject) {
              this.#asyncRejectList.push(() => reject(this.#result))
            }
          }
          return this
        }
        catch(reject) {
          if (this.#status === 'rejected' && reject) {
            reject(this.#result)
          }
          if (this.#status === 'pending' && reject) {
            this.#asyncRejectList.push(() => reject(this.#result))
          }
          return this
        }
      }

      //测试用例
      new MyPromise((resolve, reject) => {
        console.log('create promise')
        reject('error message')
      }).then(res => {
        console.log('trigger resolve')
        console.log(res)
      }).catch(err => {
        console.log('trigger catch')
        console.log(err)
      })
    }
  </script>
</body>

</html>